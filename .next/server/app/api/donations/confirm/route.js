(()=>{var e={};e.id=574,e.ids=[574],e.modules={11185:e=>{"use strict";e.exports=require("mongoose")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},61212:e=>{"use strict";e.exports=require("async_hooks")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},55315:e=>{"use strict";e.exports=require("path")},76162:e=>{"use strict";e.exports=require("stream")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},63757:e=>{"use strict";e.exports=import("prettier/plugins/html")},45747:e=>{"use strict";e.exports=import("prettier/standalone")},84492:e=>{"use strict";e.exports=require("node:stream")},87529:()=>{},39516:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>S,staticGenerationAsyncStorage:()=>f});var i={};r.r(i),r.d(i,{POST:()=>y});var a=r(73278),s=r(45002),n=r(54877),o=r(71309),d=r(1035),u=r(35522),c=r(47861),p=r(90401),m=r(54015),l=r(95090);async function y(e){try{await (0,d.Z)();let{paymentIntentId:t}=await e.json(),{orderId:r,paymentId:i,signature:a}=t;if(!r||!i||!a)return o.NextResponse.json({error:"Order ID, Payment ID, and Signature are required"},{status:400});let s=await u.Z.findOne({paymentId:r}).populate("donor","name email").populate("charity","name email");if(!s)return o.NextResponse.json({error:"Donation not found"},{status:404});if("completed"===s.status)return o.NextResponse.json({message:"Donation already confirmed"},{status:200});if(!new m.U().verifyPayment(r,i,a))return s.status="failed",await s.save(),o.NextResponse.json({error:"Invalid payment signature"},{status:400});s.status="completed",s.transactionId=i,s.confirmedAt=new Date,await s.save();let n=await u.Z.findOne({donor:s.donor._id,charity:s.charity._id,status:"completed",_id:{$ne:s._id}});await c.Z.findByIdAndUpdate(s.donor._id,{$push:{donationHistory:s._id},$inc:{totalDonated:s.amount}});let y={$inc:{totalReceived:s.amount,...!n&&{donorCount:1}}};await p.Z.findByIdAndUpdate(s.charity._id,y);try{await (0,l.C)({to:s.donor.email,subject:"Donation Confirmation - Thank You!",html:l.v.donationConfirmation?l.v.donationConfirmation(s.donor.name,s.charity.name,s.amount,s._id.toString()):`
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
              <h2 style="color: #16a34a;">Thank You for Your Donation!</h2>
              <p>Dear ${s.donor.name},</p>
              <p>Your donation of $${s.amount} to ${s.charity.name} has been successfully processed.</p>
              <p><strong>Transaction ID:</strong> ${i}</p>
              <p><strong>Receipt Number:</strong> ${s._id}</p>
              ${s.message?`<p><strong>Your Message:</strong> ${s.message}</p>`:""}
              ${s.dedicatedTo?`<p><strong>Dedicated To:</strong> ${s.dedicatedTo}</p>`:""}
              <p>Thank you for making a difference!</p>
              <p>Best regards,<br>The Charity Platform Team</p>
            </div>
          `}),await (0,l.C)({to:s.charity.email,subject:"New Donation Received",html:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #16a34a;">New Donation Received!</h2>
            <p>Dear ${s.charity.name} Team,</p>
            <p>You have received a new donation of $${s.amount}${s.isAnonymous?" from an anonymous donor":` from ${s.donor.name}`}.</p>
            ${s.message?`<p><strong>Donor Message:</strong> ${s.message}</p>`:""}
            ${s.dedicatedTo?`<p><strong>Dedicated To:</strong> ${s.dedicatedTo}</p>`:""}
            <p><strong>Transaction ID:</strong> ${i}</p>
            <p><strong>Receipt Number:</strong> ${s._id}</p>
            <p>The funds will be transferred to your account as per the processing schedule.</p>
            <p>Best regards,<br>The Charity Platform Team</p>
          </div>
        `})}catch(e){console.error("Failed to send confirmation emails:",e)}return o.NextResponse.json({success:!0,message:"Donation confirmed successfully",donation:{id:s._id,amount:s.amount,currency:s.currency,transactionId:i,receiptNumber:s._id.toString(),status:s.status,confirmedAt:s.confirmedAt}})}catch(e){if(console.error("Confirm donation error:",e),"ValidationError"===e.name)return o.NextResponse.json({error:"Validation failed",details:e.message},{status:400});return o.NextResponse.json({error:"Internal server error"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/donations/confirm/route",pathname:"/api/donations/confirm",filename:"route",bundlePath:"app/api/donations/confirm/route"},resolvedPagePath:"C:\\Users\\Shivam\\Desktop\\charity-donation-backend (1)\\app\\api\\donations\\confirm\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:S}=h,q="/api/donations/confirm/route";function w(){return(0,n.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:f})}},54015:(e,t,r)=>{"use strict";r.d(t,{U:()=>i});class i{constructor(){if(process.env.RAZORPAY_KEY_ID&&process.env.RAZORPAY_KEY_SECRET){let e=r(2555);this.razorpay=new e({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_KEY_SECRET})}}async createOrder(e,t="INR",r={}){try{return await this.razorpay.orders.create({amount:Math.round(100*e),currency:t,notes:r})}catch(e){throw console.error("Razorpay order creation error:",e),Error("Failed to create Razorpay order")}}async verifyPayment(e,t,i){try{return r(84770).createHmac("sha256",process.env.RAZORPAY_KEY_SECRET).update((e+"|"+t).toString()).digest("hex")===i}catch(e){return console.error("Razorpay verification error:",e),!1}}}},90401:(e,t,r)=>{"use strict";r.d(t,{Z:()=>o});var i=r(11185),a=r.n(i),s=r(93981);let n=new i.Schema({name:{type:String,required:[!0,"Charity name is required"],trim:!0,maxlength:[100,"Name cannot exceed 100 characters"]},email:{type:String,required:[!0,"Email is required"],unique:!0,lowercase:!0,match:[/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,"Please enter a valid email"]},password:{type:String,required:[!0,"Password is required"],minlength:[6,"Password must be at least 6 characters"],select:!1},registrationNumber:{type:String,required:[!0,"Registration number is required"],unique:!0},phone:{type:String,required:[!0,"Phone number is required"],match:[/^\+?[\d\s-()]+$/,"Please enter a valid phone number"]},website:{type:String,match:[/^https?:\/\/.+/,"Please enter a valid website URL"]},description:{type:String,required:[!0,"Description is required"],maxlength:[1e3,"Description cannot exceed 1000 characters"]},mission:{type:String,required:[!0,"Mission statement is required"],maxlength:[500,"Mission cannot exceed 500 characters"]},vision:{type:String,required:[!0,"Vision statement is required"],maxlength:[500,"Vision cannot exceed 500 characters"]},category:{type:String,required:[!0,"Category is required"],enum:["Education","Healthcare","Environment","Poverty","Animal Welfare","Disaster Relief","Human Rights","Arts & Culture","Sports","Other"]},location:{address:{type:String,required:[!0,"Address is required"]},city:{type:String,required:[!0,"City is required"]},state:{type:String,required:[!0,"State is required"]},country:{type:String,required:[!0,"Country is required"]},coordinates:{lat:Number,lng:Number}},logo:String,images:{type:[String],default:["https://picsum.photos/seed/1/600/400","https://picsum.photos/seed/2/600/400","https://picsum.photos/seed/3/600/400"]},isVerified:{type:Boolean,default:!1},isApproved:{type:Boolean,default:!1},approvedBy:{type:i.Schema.Types.ObjectId,ref:"User"},approvedAt:Date,documents:{registrationCertificate:{type:String,required:!1},taxExemptionCertificate:String,auditReport:String},bankDetails:{accountName:{type:String,required:[!0,"Account name is required"]},accountNumber:{type:String,required:[!0,"Account number is required"]},bankName:{type:String,required:[!0,"Bank name is required"]},ifscCode:{type:String,required:[!0,"IFSC code is required"]},branch:{type:String,required:[!0,"Branch is required"]}},goals:[{title:{type:String,required:!0},description:{type:String,required:!0},targetAmount:{type:Number,required:!0,min:0},currentAmount:{type:Number,default:0,min:0},deadline:Date,isActive:{type:Boolean,default:!0}}],impactReports:[{type:i.Schema.Types.ObjectId,ref:"ImpactReport"}],totalReceived:{type:Number,default:0},donorCount:{type:Number,default:0},rating:{type:Number,default:0,min:0,max:5},reviews:[{user:{type:i.Schema.Types.ObjectId,ref:"User",required:!0},rating:{type:Number,required:!0,min:1,max:5},comment:{type:String,maxlength:[500,"Comment cannot exceed 500 characters"]},createdAt:{type:Date,default:Date.now}}],socialMedia:{facebook:String,twitter:String,instagram:String,linkedin:String}},{timestamps:!0});n.pre("save",async function(e){if(!this.isModified("password"))return e();try{let t=await s.ZP.genSalt(12);this.password=await s.ZP.hash(this.password,t),e()}catch(t){e(t)}}),n.methods.comparePassword=async function(e){return s.ZP.compare(e,this.password)},n.pre("save",function(e){if(this.reviews&&this.reviews.length>0){let e=this.reviews.reduce((e,t)=>e+t.rating,0);this.rating=e/this.reviews.length}e()});let o=a().models.Charity||a().model("Charity",n)},35522:(e,t,r)=>{"use strict";r.d(t,{Z:()=>n});var i=r(11185),a=r.n(i);let s=new i.Schema({donor:{type:i.Schema.Types.ObjectId,ref:"User",required:[!0,"Donor is required"]},charity:{type:i.Schema.Types.ObjectId,ref:"Charity",required:[!0,"Charity is required"]},amount:{type:Number,required:[!0,"Amount is required"],min:[1,"Amount must be at least 1"]},currency:{type:String,required:[!0,"Currency is required"],enum:["USD","INR","EUR","GBP"],default:"USD"},paymentMethod:{type:String,required:[!0,"Payment method is required"],enum:["stripe","razorpay"]},paymentId:{type:String,required:[!0,"Payment ID is required"]},paymentStatus:{type:String,enum:["pending","completed","failed","refunded"],default:"pending"},transactionId:String,isAnonymous:{type:Boolean,default:!1},message:{type:String,maxlength:[500,"Message cannot exceed 500 characters"]},dedicatedTo:{type:String,maxlength:[100,"Dedication cannot exceed 100 characters"]},receiptUrl:String,receiptNumber:{type:String},taxDeductible:{type:Boolean,default:!0},refundReason:String,refundedAt:Date,metadata:{campaignId:String,source:String,utm:{source:String,medium:String,campaign:String}}},{timestamps:!0});s.pre("save",function(e){if(!this.receiptNumber){let e=Date.now().toString(),t=Math.random().toString(36).substring(2,8).toUpperCase();this.receiptNumber=`RCP-${e}-${t}`}e()});let n=a().models.Donation||a().model("Donation",s)},47861:(e,t,r)=>{"use strict";r.d(t,{Z:()=>o});var i=r(11185),a=r.n(i),s=r(93981);let n=new i.Schema({name:{type:String,required:[!0,"Name is required"],trim:!0,maxlength:[50,"Name cannot exceed 50 characters"]},email:{type:String,required:[!0,"Email is required"],unique:!0,lowercase:!0,match:[/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,"Please enter a valid email"]},password:{type:String,required:[!0,"Password is required"],minlength:[6,"Password must be at least 6 characters"],select:!1},phone:{type:String,match:[/^\+?[\d\s-()]+$/,"Please enter a valid phone number"]},address:{street:String,city:String,state:String,zipCode:String,country:String},profileImage:String,isVerified:{type:Boolean,default:!1},role:{type:String,enum:["user","admin"],default:"user"},donationHistory:[{type:i.Schema.Types.ObjectId,ref:"Donation"}],totalDonated:{type:Number,default:0}},{timestamps:!0});n.pre("save",async function(e){if(!this.isModified("password"))return e();try{let t=await s.ZP.genSalt(12);this.password=await s.ZP.hash(this.password,t),e()}catch(t){e(t)}}),n.methods.comparePassword=async function(e){return s.ZP.compare(e,this.password)};let o=a().models.User||a().model("User",n)},8881:e=>{function t(e,t,r,i){return Math.round(e/r)+" "+i+(t>=1.5*r?"s":"")}e.exports=function(e,r){r=r||{};var i,a,s=typeof e;if("string"===s&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return 864e5*r;case"hours":case"hour":case"hrs":case"hr":case"h":return 36e5*r;case"minutes":case"minute":case"mins":case"min":case"m":return 6e4*r;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}(e);if("number"===s&&isFinite(e))return r.long?(i=Math.abs(e))>=864e5?t(e,i,864e5,"day"):i>=36e5?t(e,i,36e5,"hour"):i>=6e4?t(e,i,6e4,"minute"):i>=1e3?t(e,i,1e3,"second"):e+" ms":(a=Math.abs(e))>=864e5?Math.round(e/864e5)+"d":a>=36e5?Math.round(e/36e5)+"h":a>=6e4?Math.round(e/6e4)+"m":a>=1e3?Math.round(e/1e3)+"s":e+"ms";throw Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[379,833,981,555,632],()=>r(39516));module.exports=i})();