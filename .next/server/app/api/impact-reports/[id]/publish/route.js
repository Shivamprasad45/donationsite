"use strict";(()=>{var e={};e.id=731,e.ids=[731],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},63757:e=>{e.exports=import("prettier/plugins/html")},45747:e=>{e.exports=import("prettier/standalone")},84492:e=>{e.exports=require("node:stream")},12806:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>y,serverHooks:()=>S,staticGenerationAsyncStorage:()=>f});var i={};r.r(i),r.d(i,{POST:()=>h});var a=r(73278),n=r(45002),s=r(54877),o=r(71309),d=r(1035),u=r(38014),p=r(35522),c=r(47861),m=r(16910),l=r(95090);async function h(e,{params:t}){try{await (0,d.Z)();let r=await (0,m.Ym)(e);if(!r||"charity"!==r.role)return o.NextResponse.json({error:"Charity access required"},{status:403});let i=await u.Z.findById(t.id).populate("charity","name");if(!i)return o.NextResponse.json({error:"Impact report not found"},{status:404});if(i.charity._id.toString()!==r.charityId)return o.NextResponse.json({error:"Unauthorized"},{status:403});if(i.isPublished)return o.NextResponse.json({error:"Report is already published"},{status:400});i.isPublished=!0,i.publishedAt=new Date,await i.save();try{let e=await p.Z.find({charity:r.charityId,paymentStatus:"completed"}).populate("donor","name email").distinct("donor");for(let t of(await c.Z.find({_id:{$in:e}})))await (0,l.C)({to:t.email,subject:`New Impact Report from ${i.charity.name}`,html:l.v.impactReportNotification(t.name,i.charity.name,i.title)})}catch(e){console.error("Failed to send impact report notifications:",e)}return o.NextResponse.json({message:"Impact report published successfully",report:{id:i._id,title:i.title,isPublished:i.isPublished,publishedAt:i.publishedAt}})}catch(e){return console.error("Publish impact report error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/impact-reports/[id]/publish/route",pathname:"/api/impact-reports/[id]/publish",filename:"route",bundlePath:"app/api/impact-reports/[id]/publish/route"},resolvedPagePath:"C:\\Users\\Shivam\\Desktop\\charity-donation-backend (1)\\app\\api\\impact-reports\\[id]\\publish\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:S}=y,q="/api/impact-reports/[id]/publish/route";function b(){return(0,s.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:f})}},16910:(e,t,r)=>{r.d(t,{RA:()=>s,Ym:()=>o});var i=r(67390),a=r.n(i);let n=process.env.JWT_SECRET;if(!n)throw Error("Please define the JWT_SECRET environment variable");function s(e){return a().sign(e,n,{expiresIn:"7d"})}async function o(e){try{let t=function(e){let t=e.headers.get("authorization");return t&&t.startsWith("Bearer ")?t.substring(7):null}(e);if(!t)return null;return a().verify(t,n)}catch(e){return null}}},35522:(e,t,r)=>{r.d(t,{Z:()=>s});var i=r(11185),a=r.n(i);let n=new i.Schema({donor:{type:i.Schema.Types.ObjectId,ref:"User",required:[!0,"Donor is required"]},charity:{type:i.Schema.Types.ObjectId,ref:"Charity",required:[!0,"Charity is required"]},amount:{type:Number,required:[!0,"Amount is required"],min:[1,"Amount must be at least 1"]},currency:{type:String,required:[!0,"Currency is required"],enum:["USD","INR","EUR","GBP"],default:"USD"},paymentMethod:{type:String,required:[!0,"Payment method is required"],enum:["stripe","razorpay"]},paymentId:{type:String,required:[!0,"Payment ID is required"]},paymentStatus:{type:String,enum:["pending","completed","failed","refunded"],default:"pending"},transactionId:String,isAnonymous:{type:Boolean,default:!1},message:{type:String,maxlength:[500,"Message cannot exceed 500 characters"]},dedicatedTo:{type:String,maxlength:[100,"Dedication cannot exceed 100 characters"]},receiptUrl:String,receiptNumber:{type:String},taxDeductible:{type:Boolean,default:!0},refundReason:String,refundedAt:Date,metadata:{campaignId:String,source:String,utm:{source:String,medium:String,campaign:String}}},{timestamps:!0});n.pre("save",function(e){if(!this.receiptNumber){let e=Date.now().toString(),t=Math.random().toString(36).substring(2,8).toUpperCase();this.receiptNumber=`RCP-${e}-${t}`}e()});let s=a().models.Donation||a().model("Donation",n)},38014:(e,t,r)=>{r.d(t,{Z:()=>s});var i=r(11185),a=r.n(i);let n=new i.Schema({charity:{type:i.Schema.Types.ObjectId,ref:"Charity",required:[!0,"Charity is required"]},title:{type:String,required:[!0,"Title is required"],maxlength:[200,"Title cannot exceed 200 characters"]},description:{type:String,required:[!0,"Description is required"],maxlength:[2e3,"Description cannot exceed 2000 characters"]},reportPeriod:{startDate:{type:Date,required:[!0,"Start date is required"]},endDate:{type:Date,required:[!0,"End date is required"]}},totalFundsReceived:{type:Number,required:[!0,"Total funds received is required"],min:0},totalFundsUtilized:{type:Number,required:[!0,"Total funds utilized is required"],min:0},beneficiariesReached:{type:Number,required:[!0,"Beneficiaries reached is required"],min:0},projects:[{name:{type:String,required:!0},description:{type:String,required:!0},fundsAllocated:{type:Number,required:!0,min:0},fundsUtilized:{type:Number,required:!0,min:0},status:{type:String,enum:["planned","ongoing","completed","cancelled"],required:!0},beneficiaries:{type:Number,required:!0,min:0},images:[String],outcomes:[String]}],financialBreakdown:[{category:{type:String,required:!0},amount:{type:Number,required:!0,min:0},percentage:{type:Number,required:!0,min:0,max:100},description:String}],images:[String],documents:[String],isPublished:{type:Boolean,default:!1},publishedAt:Date},{timestamps:!0});n.pre("save",function(e){this.isModified("isPublished")&&this.isPublished&&!this.publishedAt&&(this.publishedAt=new Date),e()});let s=a().models.ImpactReport||a().model("ImpactReport",n)},47861:(e,t,r)=>{r.d(t,{Z:()=>o});var i=r(11185),a=r.n(i),n=r(93981);let s=new i.Schema({name:{type:String,required:[!0,"Name is required"],trim:!0,maxlength:[50,"Name cannot exceed 50 characters"]},email:{type:String,required:[!0,"Email is required"],unique:!0,lowercase:!0,match:[/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,"Please enter a valid email"]},password:{type:String,required:[!0,"Password is required"],minlength:[6,"Password must be at least 6 characters"],select:!1},phone:{type:String,match:[/^\+?[\d\s-()]+$/,"Please enter a valid phone number"]},address:{street:String,city:String,state:String,zipCode:String,country:String},profileImage:String,isVerified:{type:Boolean,default:!1},role:{type:String,enum:["user","admin"],default:"user"},donationHistory:[{type:i.Schema.Types.ObjectId,ref:"Donation"}],totalDonated:{type:Number,default:0}},{timestamps:!0});s.pre("save",async function(e){if(!this.isModified("password"))return e();try{let t=await n.ZP.genSalt(12);this.password=await n.ZP.hash(this.password,t),e()}catch(t){e(t)}}),s.methods.comparePassword=async function(e){return n.ZP.compare(e,this.password)};let o=a().models.User||a().model("User",s)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[379,833,981,390,632],()=>r(12806));module.exports=i})();